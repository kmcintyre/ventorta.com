<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="redux-mixin.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-twitter">
   <template>   
      <style include="shared-styles iron-flex iron-flex-alignment">
          :host {          		
			--paper-card: {
				margin: 12px;
	        	width: 300px;
	        	@apply(--layout-self-strech);
	        };              	
	        --paper-card-header: {
        		@apply(--layout-vertical);
        		@apply(--layout-center);
    		};
			--paper-card-header-image:{
           		width:120px;
           		margin: 6px
        	};	
         }
         .container {
         	text-align:center
         }
      </style>
      
			<template is="dom-repeat" items="[[tweets]]" as="tweet">
    				<paper-card image="[[avatar(tweet)]]">
    					<div>
    						<span class="hidden">{{_toString(tweet)}}</span>                  
                    		<span class="twitter">{{tweet.twitter}}</span>
                		</div>
                		
                		  <template is="dom-if" if="[[tweet.rank]]">                		
						  	 <div class="layout horizontal">
						  	 	<div class="flex layout vertical">
						  	 		<span>Rank</span>
						  	 	</div>
						  	 	<div class="flex layout vertical">
						  	 		<span>[[tweet.rank]]</span>
						  	 	</div>
						  	 </div>
						  </template>
                		
		                  <template is="dom-if" if="[[isLeague(tweet, 'market')]]">
						  	 <div class="layout horizontal">
						  	 	<div class="flex layout vertical">
						  	 		<div>
						  	 			<span>{{tweet.index}}</span><span>{{tweet.symbol}}</span>
						  	 		</div>
						  	 	</div>
						  	 	<div class="flex layout vertical">
						  	 		<span>${{tweet.price}}</span>
						  	 	</div>
						  	 </div>
		                  </template>
		                  
						  <template is="dom-if" if="[[isLeague(tweet,'startup')]]">
						  	 <div class="layout horizontal">
						  	 	<div class="flex layout vertical">
						  	 		<span class="incubator">Incubator</span>
						  	 	</div>
						  	 	<div class="flex layout vertical">
						  	 		<span>{{tweet.incubator}}</span>
						  	 	</div>
						  	 </div>
		                  </template>
		                  
		                  <template is="dom-if" if="[[isLeague(tweet,'venture')]]">
						  	 <div class="layout horizontal">
						  	 	<div class="flex layout vertical">
						  	 		<span>Valuation</span>
						  	 	</div>
						  	 	<div class="flex layout vertical">
						  	 		<span>$B [[_toValuation(item)]]</span>
						  	 	</div>
						  	 </div>
		                  </template>                		
            		</paper-card>
    		</template>
   </template>
   <script>   	  
   	  class MyTwitter extends ReduxMixin(Polymer.Element) {   
      
        static get is() { return 'my-twitter'}
        
        static get properties() {
            return {
         	 tweets: {
                type: Array,
                statePath: 'tweets',
                observer: 'tweetsChanged'
              }, 
              readyState: {
             	 type: Number,
                  statePath: 'readyState',
                  observer: 'backfill'
              },
              share: {
            	  type: Object,
            	  statePath: 'share'
              }
          } 
        }

        static get actions() {
            return {
         	   websocketRequest(request) {
                    return {
                        type: 'WEBSOCKET_REQUEST',
                        request
                      };					        		   
         	   }
            }
        }
        
		avatar(item) {
	 		return 'http://' + nativeDomain() + '/' + item.league + '/large/' + item.twitter + '.png'
	 	}	
        
        tweetsChanged(tweets) {
     	   if ( tweets.length > 0 && tweets.length < 4 ) {
     		   this.dispatch('websocketRequest', {
 					website: nativeDomain(),
 					backfill: {
 				    	   platform: 'twitter',
 				    	   limit: 'unknown',
 				    	   tweet_id: tweets[tweets.length-1].tweet_id
 					}
 			   })
     	   }
        }        
        
        backfill(readyState) {
        	console.log('ready state', readyState)
     	   if ( readyState == 1) {
     		   this.dispatch('websocketRequest', {
             	   website: nativeDomain(),
             	   backfill: {
             		   platform: 'twitter',
             		   limit: 'unknown'
             	   }
                })    		   
     	   }
        }        
        _toString(item) {
        	return JSON.stringify(item)
        }
        _toValuation(v) {
        	return v.valuation.substring(1, v.valuation.indexOf(' '))
        }
        _toKeys(obj) {
            return Object.keys(obj);
        }
        isLeague(item, ln) {
			return item.league == ln;
		}
      }
   	customElements.define(MyTwitter.is, MyTwitter);
   </script>
</dom-module>