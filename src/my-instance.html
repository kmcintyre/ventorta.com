<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/notification-icons.html">

<link rel="import" href="redux-mixin.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-instance">
   <template>
      <style include="shared-styles iron-flex iron-flex-alignment">
         :host {         	
         	--paper-card: {
	        margin: 12px 6px 12px 6px;
	        width: 300px;
	        text-align:left;
	      }	
         }   
		 paper-fab.retracted ~ div {		 	
		 	display:none;
		 }		 
		 paper-fab.changed ~ div:nth-of-type(1) {		 	
		 	display:none;
		 }		 
		 paper-fab.extended ~ div:nth-of-type(2) {		 	
		 	display:none;
		 }
		.container > paper-fab[disabled] {
			background: var(--paper-grey-300); 
		 }		 		 
		 .container > paper-fab:not(disabled) {
		 	background: #4CAF50;
		 }
		 .container {
		 	width:100%
		 }
		 .container {
    		@apply(--layout-horizontal);
    		@apply(--layout-center);
    	 }
    	 .inner {
    		@apply(--layout-horizontal);    		    		      	
		 }
		 .action {
		 	@apply(--layout-flex);
		 }
		 .inner paper-item {
		 	padding: 0px 8px;
		 }
		 .instance {
		 	cursor: pointer;
		 }
		 .dates div {
		 	@apply(--layout-flex);
		 }
		 .dates div {
		 	padding: 4px;
		 	white-space: nowrap
		 }
		 .dates div:nth-child(2) {
		 	
		 }
		 .name {
		 	 font-size: 1.12em;		 	 
		 }
      </style>
				<paper-card>
                     	<paper-item><span class="instance rspace" on-click="launch"></span><span class="name space">{{instance.tag}}</span></paper-item>
                     	<div class="container">
                     		<paper-fab class="label retracted" label="{{balance(instance)}}" title="balance" on-click="extend"></paper-fab>                           	                     	          						
   							<div class="inner">   							
   								<template is="dom-repeat" items="[[acts]]" as="act">
   									<paper-item>
   										<paper-fab mini 
   												icon="[[act.icon]]" 
   												title="[[act.title]]"
   												data-instance-id$="[[instance.id]]"
   												data-tag$="[[instance.tag]]"   												
   												on-click="action"
   												data-action$="[[act.action]]"
   												disabled="{{disable(act, instance)}}"></paper-fab>   												
   									</paper-item>
   								</template>
        					</div>
        					<div class="inner action">
        						<span></span>        						        					
        					</div>
   						</div>
   						<div class="horizontal layout dates">
   							<div class="vertical layout end">
   								<div>Launch</div>
   								<div>Reboot</div>
   								<template is="dom-if" if="{{operators.length > 0 && leagues.length > 0 && curators.length > 0}}">
	   								<template is="dom-repeat" items="{{operator(instance)}}" as="operator">
	   									<div>
	   										<a href="{{bible(instance)}}" target="_blank">Bible</a>	   											   									
	   									</div>
	   									<div>Scout</div>
	   									<div>Match</div>
	   									<div>Friends</div>
	   								</template>
	   							</template>
   							</div>
   							<div class="flex" style="text-align:center"><span class="calendar"></span></div>
							<div class="vertical layout">
   								<div class="">{{date(instance.launch_time)}}</div>
   								<div>{{tag(instance, 'Reboot')}}</div>
   								<template is="dom-if" if="{{operators.length > 0}}">
	   								<template is="dom-repeat" items="{{operator(instance)}}" as="operator">
	   									<div>{{date(operator.ts_bible)}}</div>
	   									<div>{{date(operator.ts_stalked)}}</div>
	   									<div>{{date(operator.ts_match_twitter)}}</div>
	   									<div>{{date(operator.ts_inflated)}}</div>
	   								</template>
								</template>
   							</div>
   						</div>
   						<template is="dom-repeat" items="{{operator(instance)}}" as="operator">
							<div style="width:100%; text-align:center; position:relative;">
							  <div class="layout horizontal center" style="padding: 2px 12px 2px 12px">								
									<div class="entity flex">
										{{number_twitter(operator.entity_count)}}
									</div>
									<div class="twitter flex">
										{{number_twitter(operator.twitter_count)}}
									</div>								
									<div class="instagram flex">
										{{number_twitter(operator.instagram_count)}}
									</div>								
									<div class="facebook flex">
										{{number_twitter(operator.facebook_count)}}
									</div>										   							
								</div>
								<template is="dom-if" if="{{operator.locked}}">
	   								<iron-icon icon="notification:network-locked" style="position:absolute; right:0px; bottom: 0px; fill: red"></iron-icon>
								</template>							
							</div>							   						
   						</template>
                        <textarea style="display:none; width:100%; height:100px">{{stringify(instance)}}</textarea>
                     </paper-card>
   </template>
   <script> 
 	 function closest(el, selector) {
   	     if (!el || !el.parentElement) return null
   	     else if (el.parentElement.matches(selector)) return el.parentElement
   	     else return closest(el.parentElement, selector)
   	 }

   	 class MyInstance extends ReduxMixin(Polymer.Element) {
   	     static get is() {
   	         return 'my-instance';
   	     }
   	     static get properties() {
   	         return {
   	             curators: {
   	                 type: Array,
   	                 statePath: 'curators'
   	             },
   	             leagues: {
   	                 type: Array,
   	                 statePath: 'leagues'
   	             },
   	             operators: {
   	                 type: Array,
   	                 statePath: 'operators'
   	             },   	 
   	        	 instance: {
   	               type: Object,
   	               notify: true // fire mydata-change CustomEvent on change
   	             },
   	             acts: {
   	                 type: Array,
   	                 value: [{
   	                         icon: 'maps:local-hospital',
   	                         title: 'Replace',
   	                         notag: true,
   	                         action: 'Replacing'
   	                     },
   	                     {
   	                         icon: 'cached',
   	                         title: 'Reboot',
   	                         disable: ['stopped'],
   	                         action: 'Rebooting'
   	                     },
   	                     {
   	                         icon: 'av:stop',
   	                         title: 'Stop',
   	                         disable: ['stopped'],
   	                         action: 'Stopping'
   	                     },
   	                     {
   	                         icon: 'av:play-arrow',
   	                         title: 'Start',
   	                         disable: ['running'],
   	                         action: 'Starting'
   	                     }
   	                 ]
   	             }
   	         }
   	     }
   	     operator(instance) {
   	    	 if ( this.operators ) {
   	    		 return this.operators.filter(function(o) { return o.role == instance.tag.split('.')[0] })
   	    	 }  	    	 
   	     }
   	     curator(instance) {
   	    	 if ( this.curator ) {
   	    		 return this.curators.filter(function(c) { return c.site_leagues.indexOf(instance.tag.split('.')[0]) > -1 })
   	    	 }
   	    	 return [];  	    	 
   	     }   	     
   	     league(instance) {
   	    	 if ( this.leagues ) {
   	    		 return this.leagues.filter(function(l) { return l.league == instance.tag.split('.')[0] })
   	    	 }
   	    	 return [];
   	     }
   	     isSite(instance) {
   	    	return instance.tag.split('.').length == 3
   	     }
   	     bible(instance) {
   	    	return "http://" + this.curator(instance)[0].role + '/' + this.operator(instance)[0].role + '/db/league.json';
    	 }   	     
   	     disable(act, instance) {
   	         if (act.notag && instance.tag == 'untagged' || (act.disable && act.disable.indexOf(instance.state)) > -1) {
   	             return true;
   	         }
   	         return false;
   	     }
   	     tag(instance, name) {
   	    	var value = instance.tags[name] 
   	    	if ( value ) {
   	    		return this.date(value)
   	    	} else {
   	    		value = instance.tags[name.toLowerCase()]
   	    		if ( value ) {
   	    			return this.date(value)
   	    		}   	    		
   	    	}
   	    	return this.date()
   	     }
   	     action(event) {
   	         var up = {
   	             id: event.target.dataset.instanceId,
   	             perform: event.target.title.toLowerCase(),
   	             tag: event.target.dataset.tag
   	         };
   	         if (up.tag.split('.').length == 3) {
   	             up.destination = 'http://service.' + up.tag.substring(up.tag.indexOf('.') + 1)
   	         } else {
   	             up.destination = 'http://service.' + nativeDomain();
   	         }
   	         
   	         up.destination += '/site/instances';
   	         var container = closest(event.target.parentNode, '.container');
   	         var pf = container.querySelector('paper-fab');
   	         pf.disabled = true;
   	         pf.classList.remove("extended");
   	         pf.classList.add("changed");
   	         console.log(event.target.dataset.action)
   	         container.querySelector('.inner.action span').innerHTML = event.target.dataset.action

   	         var request = new Request(up.destination, {
   	         	method: 'POST', 
   	         	mode: 'cors',
   	         	body: JSON.stringify(up)
   	         });
   	         
   	         fetch(request).then(function (ans) {
   	         	console.log('ans:', ans)
   	         })   	         
   	     }
   	     launch(event) {
   	         var site = event.target.parentNode.querySelector('span.name').innerHTML;
   	         if (site.split('.').length == 3) {
   	             window.open('http://' + site, '_blank');
   	         } else if (site == 'mail') {
   	             window.open('http://www.scewpt.com/inbox/index.html', '_blank');
   	         } else if (site.indexOf('service') > -1) {
   	             window.open('http://service.' + nativeDomain(), '_blank');
   	         }
   	     }
   	     extend(event) {
   	         console.log('extend:', event.target.className)
   	         if (event.target.classList.contains('retracted')) {
   	             event.target.classList.remove("retracted");
   	             event.target.classList.add("extended");
   	         } else {
   	             event.target.classList.remove("extended");
   	             event.target.classList.add("retracted");
   	         }
   	     }
   	     extendedClass(index) {
   	         if (this.instances && this.instances[index].extended) {
   	             return 'extended';
   	         }
   	         return 'retracted';
   	     }
   	     balance(instance) {
   	         if (instance.balance) {
   	             return parseInt(instance.balance)
   	         } else {
   	             return 0
   	         }
   	     }
   	     date(t) {
   	    	 if ( t ) {
   	    		var d = new Date(t * 1000)
  	   	         if (d.toLocaleDateString() === new Date().toLocaleDateString()) {
  	   	        	 var t = d.toLocaleTimeString();
  	   	        	 
  	   	             return t.split(':')[0] + ':' + t.split(':')[1] + ' ' + t.split(' ')[1] 
  	   	         } else {
  	   	             return d.toLocaleDateString().split('/')[0] + '/' + d.toLocaleDateString().split('/')[1];
  	   	         }
   	    	 }
   	    	 return '';
   	     }
   	     stringify(item) {
   	         return JSON.stringify(item);
   	     }
   	  	 number_twitter(tn) {
			if ( tn == 0 ) {
				return '0';
			} else if ( tn / 1000000 >= 1 ) {
				return '' + parseInt(tn / 1000000) + '.' + parseInt((tn % 1000000)/10000) + 'M';
			} else if ( tn / 1000 >= 1) {
				return '' + parseInt(tn / 1000) + '.' + parseInt((tn % 1000)/100) + 'K';		
			} else {
				return '' + tn;
			}
	   }   	     
   	 }

   	 customElements.define(MyInstance.is, MyInstance);      
   </script>
</dom-module>