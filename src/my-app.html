<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="redux-mixin.html">

<link rel="import" href="my-data.html">
<link rel="import" href="my-websocket.html">

<link rel="import" href="my-footer.html">
<link rel="import" href="my-listbox.html">


<link rel="import" href="shared-styles.html">

<dom-module id="my-app">
   <template>
      <style include="shared-styles">
         :host {
             --app-drawer-width: 250px;
         }
         app-drawer-layout:not([narrow]) [drawer-toggle] {
             display: none;
         }
         .menu {
             width: 48px;
             height: 48px;
         }
         div.iron-selected {
             width: 100%;
             height: 100%;
         }
         app-header {
             background-image: url(/curator_background.png);
             height: 200px;
         }
         google-chart {
             width: 100%;
         }
         app-toolbar .title {
             display: inline;
             font-family: 'Permanent Marker', cursive;
             font-size: 48px;
         }
         [condensed-title] .title {
             font-size: 36px;
         }
         .trans {
             background-color: rgba(255, 255, 255, 0.75);
             border-radius: 12px;
             padding: 0 6px 0 6px;
         }
         ul {
             list-style: none;
             padding: 0;
         }
         li {
             font-size: 1.66em;
             width: 150px;
             vertical-align: middle;
         }
         li span:nth-child(2) {
             float: right;
         }
         #stats {
             position: absolute;
             right: 8px;
             top: 24px;
         }
         app-drawer-layout[narrow] #stats, #stats.sideways {
             top: 140px;
         }
         .sideways ul li {
             width: auto;
             display: inline-block;;
         }
         .sideways ul li span:nth-child(1) {
             padding-right: 2px;
         }
         app-drawer-layout[narrow] #stats ul li {
             width: auto;
             display: inline-block;
             padding-left: 8px;
         }         
         app-drawer-layout[narrow] #stats.sideways {
             display: none
         }
         app-drawer-layout app-header-layout #myfooter {
             position: fixed;
             padding: 0 32px;
             bottom: 16px;
             right: 0;
             bottom: 8px;
             padding: 0 8px;
             width: calc(100% - 250px);
             box-sizing: border-box;
             z-index: 2;
         }
         app-drawer-layout[narrow] app-header-layout #myfooter {
             width: 100%
         }
         #myinstances {
             
         }  
      </style>
      <my-data id="mydata"></my-data>
      <my-websocket id="mywebsocket"></my-websocket>
      
      <app-drawer-layout>
         <app-drawer slot="drawer">
            <my-listbox id="mylistbox"></my-listbox>
         </app-drawer>
         <app-header-layout>
            <app-header id="appheader" slot="header" condenses fixed shadow  effects="resize-title">
               <app-toolbar>
                  <paper-icon-button icon="menu" drawer-toggle class="menu"></paper-icon-button>
                  <div condensed-title>
                     <h1 class="trans title">{{site}}</h1>
                  </div>
               </app-toolbar>
               <app-toolbar>
                  <div main-title spacer>
                     <h1 class="trans title">{{site}}</h1>
                  </div>
               </app-toolbar>
               <div id="stats">
                  <ul>
                     <li class="trans">
                        <span class="entities"></span>
                        <span>
                        {{curation(curators, 0, 'entity_count')}}
                        </span>
                     <li class="trans">
                        <span class="twitter"></span>
                        <span>
                        {{curation(curators, 0, 'twitter_count')}}
                        </span>
                     <li class="trans">
                        <span class="facebook"></span>
                        <span>
                        {{curation(curators, 0, 'facebook_count')}}
                        </span>
                     <li class="trans">
                        <span class="instagram"></span>
                        <span>
                        {{curation(curators, 0, 'instagram_count')}}
                        </span>
                     <li>
                  </ul>
               </div>
            </app-header>
            <iron-pages selected="[[selected]]">
	           <my-view1 name="view1"></my-view1>
	           <my-view2 name="view2"></my-view2>
	           <my-view3 name="view3"></my-view3>
	           <my-view4 name="view4"></my-view4>               
            </iron-pages>
            <my-footer id="myfooter" selected="[[selected]]"></my-footer>
         </app-header-layout>
      </app-drawer-layout>
   </template>
   <script> 	    
   class MyApp extends ReduxMixin(Polymer.Element) {
       static get is() {
           return 'my-app';
       }
       
       static get properties() {
           return {
        	 site: {
        		 type: String,
        		 statePath: 'site'
        	 },
             selected: {
               type: Number,
               reflectToAttribute: true,
               statePath: 'selected',
               observer: 'selectedChanged'
             },
             curators: {
            	 type: Array,
            	 statPath: 'curators',
            	 observer: 'curatorsChanged'
             },
             leagues: {
            	 type: Array,
            	 statPath: 'leagues',
            	 observer: 'leaguesChanged'            	
             }           
           }
         }
       static get actions() {
    	   return {
    		   updateCurators(curators) {
    			   return  {
    				   type: 'UPDATE_CURATORS',
    				   curators
    			   }
    		   },
    		   updateLeagues(leagues) {
    			   return  {
    				   type: 'UPDATE_LEAGUES',
    				   leagues
    			   }
    		   }    		   
    	   };
       }
       ready() {
           super.ready();
           Polymer.RenderStatus.afterNextRender(this, function() {
               var appheader = this.$.appheader;
               var stats = this.$.stats;
               document.addEventListener('scroll', function(e) {
                   if (appheader.getBoundingClientRect().bottom < 150 && !stats.classList.contains('sideways')) {
                       stats.classList.add('sideways')
                   } else if (appheader.getBoundingClientRect().bottom > 150 && stats.classList.contains('sideways')) {
                       stats.classList.remove('sideways')
                   }
               }, true);               
           });
       }     

       selectedChanged(selected) {
           var resolvedPageUrl = this.resolveUrl('my-view' + (selected + 1) + '.html');
           console.log('selected:', selected, resolvedPageUrl)
           Polymer.importHref(
               resolvedPageUrl,
               null,
               function () { console.log('missing:', resolvedPageUrl)},
               true
           );
       }
       
       curation(data, index, name) {
           return this.number_twitter(data[index][name]);
       }
       domain(url) {
           return '//' + nativeDomain() + url
       }
	   number_twitter(tn) {
			if ( tn == 0 ) {
				return '0';
			} else if ( tn / 1000000 >= 1 ) {
				return '' + parseInt(tn / 1000000) + '.' + parseInt((tn % 1000000)/10000) + 'M';
			} else if ( tn / 1000 >= 1) {
				return '' + parseInt(tn / 1000) + '.' + parseInt((tn % 1000)/100) + 'K';		
			} else {
				return '' + tn;
			}
	   }       
       connectedCallback() {
           super.connectedCallback();
       }
   }

   customElements.define(MyApp.is, MyApp);
   </script>
</dom-module>