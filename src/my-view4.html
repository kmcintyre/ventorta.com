<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">

<link rel="import" href="redux-mixin.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view4">
   <template>
      <style include="shared-styles iron-flex iron-flex-alignment paper-styles">
         :host {         	
         }   
         .filter {
         	padding: 12px 12px 12px 12px
         }
         .asdf {
         	@apply(--shadow-elevation-2dp);
         }
	    .match {
	      	display: inline-block;
	      	padding: 8px;	      	
	     }
	     .match {
	     	@apply --shadow-elevation-2dp;
	     }         
	     .name {
	     	width: 150px;
	     	padding: 12px;
	     	font-weight: 1.16em	     	
	     }
	     .tc {
	     	margin: 0 8px 2px 8px;
	     }
	     .twitter {
	     	margin-bottom: 10px
	     }
      </style>
      <div class="layout horizontal">
      	<div class="flex filter">
	      	<template id="selectedleagues" is="dom-repeat" items="[[uniqueLeagues]]" as="league">
	      		<paper-checkbox name$="[[ league.league ]]" checked on-click="changeFilter">      		
					{{ league.league }}      		      		    	
				</paper-checkbox>
	    	</template>
    	</div>           
    	<div class="flex filter"></div>
	  </div>
	  <iron-list items="[[sortedFilteredMatches]]" as="match" scroll-target="document">
   	  	<template>
	   	  	<div class="match">
	   	  		<div class="layout horizontal">
	   	  			<template is="dom-if" if="{{match.name}}">
	   	  				<div class="name">{{match.name}}</div>
	   	  			</template>
	   	  			<div class="layout flex"><a href="{{match.profile}}" target="_blank">{{match.profile}}</a></div>
	   	  			<div>{{match.league}}</div>
	   	  		</div>   	  		
		   	  	<template is="dom-repeat" items="{{match.match_twitter}}" as="twitter">
		   	  		<div class="layout horizontal">
		   	  			<div>
		   	  				<img src="{{twitter.avatar}}" style="border-radius:12px;padding-left:5px;padding-right:5px" width="128" height="128">
		   	  			</div>
		   	  			<div class="flex layout vertical">
		   	  				<div class="twitter">
		   	  					<a target="_blank" href="https://twitter.com/@{{twitter.twitter}}" style="font-weight:bold; font-size: 1.16em">{{twitter.twitter}}</a>	 
		   	  				</div>		   	  				
		   	  				<div class="layout horizontal">		   	  				
								<div class="layout vertical">
				   	  				<div class="tc">Peers:</div>
				   	  				<div class="tc">Found:</div>
				   	  				<div class="tc">Followers:</div>					   	  			
				   	  			</div>		   	  										   	  			
				   	  			<div class="layout vertical">
				   	  				<div class="tc">{{twitter.followers_you_know}}</div>
				   	  				<div class="tc">{{twitter.found}}</div>
				   	  				<div class="tc">{{twitter.followers}}</div>
				   	  			</div>					   	  							   	  			
				   	  			<div class="flex" style="padding:10px">{{twitter.bio}}</div>
				   	  		</div>
				   	  		<div class="layout horizontal start center center-justified">
				   	  			<paper-button 
				   	  				on-click="perform"
				   	  				profile$="{{match.profile}}"
				   	  				twitter$="{{twitter.twitter}}"
				   	  				act="yes" 
				   	  				raised 
				   	  				style="background-color: #2196f3"
				   	  				>Yes</paper-button>
								<paper-button 
									on-click="perform"
				   	  				profile$="{{match.profile}}"
				   	  				twitter$="{{twitter.twitter}}"
				   	  				act="no"									 
									raised 
									style="margin: 0 10px 0 10px; background-color: #2196f3"
									>No</paper-button>				   	  				
								<paper-button 
									on-click="perform"
				   	  				profile$="{{match.profile}}"
				   	  				twitter$="{{twitter.twitter}}"
				   	  				act="block"									 									 
									raised
									style="background-color: #2196f3"
									>Block</paper-button>
								<div style="width:25px"></div>
								<paper-input 
									label="suggest twitter"
				   	  				profile$="{{match.profile}}"				   	  				
				   	  				act="block"									 									 									 
									on-change="perform"
									>
				   	  		</div>
		   	  			</div>
		   	  		</div>		   	  		
		   	  	</template>
	   	  	</div>   	  
	   	  </template>
	  </iron-list>	      	  
	  <iron-ajax
          auto
          url="{{domain('/site/twitter/match')}}"
          handle-as="json"
          last-response="{{matches}}"
          debounce-duration="300"></iron-ajax>	  
   </template>
   <script> 
	class MyView4 extends ReduxMixin(Polymer.Element) {
	    static get is() {
	        return 'my-view4';
	    }
	    static get properties() {
	        return {
	            matches: {
	                type: Array
	            },
	            leagues: {
	                type: Array,
	                statePath: 'leagues'
	            },
	            uniqueLeagues: {
	                type: Array,
	                value: []
	            },
	            sortedFilteredMatches: {
	                type: Array,
	                value: []
	            }
	        }
	    }
	    static get observers() {
	        return ['uniques(leagues, matches)']
	    }
	    perform(e) {
	        console.log('perform:', e.target)
	        var match = {
	            profile: e.target.getAttribute('profile')
	        };
	        if (e.target.getAttribute('twitter')) {
	            match.twitter = e.target.getAttribute('twitter');
	            if (['no', 'block'].indexOf(e.target.getAttribute('act')) > -1) {
	                match[e.target.getAttribute('act')] = true;
	            }
	        } else {
	            match.twitter = e.target.value
	        }
	        
	        console.log(match)
	        
			var request = new Request('http://service.' + nativeDomain() + '/site/twitter/match', {
   	         	method: 'POST', 
   	         	mode: 'cors',
   	         	body: JSON.stringify(match)
   	        });
   	         
   	        fetch(request).then(function (ans, ans2, ans3) {
   	         	console.log('ans:', ans)
   	        })	        
	    }
	    changeFilter(e) {
	        Polymer.RenderStatus.afterNextRender(this, function() {
	            this.sortFilter()
	        });
	    }
	    sortFilter() {
	        var sr = this.shadowRoot
	        var filtered_matches = this.matches.filter(function(m) {
	            var q = sr.querySelector('paper-checkbox[name="' + m.league + '"][checked]')
	            if (q) {
	                return true;
	            }
	            return false;
	        });
	        filtered_matches.forEach(function(match) {
	            match.match_twitter.forEach(function(matchitem) {
	                matchitem['found'] = new Date(matchitem['ts_match_twitter'] * 1000).toLocaleDateString();
	            });
	            match.match_twitter.sort(function(a, b) {
	                return (b.tweeter_home_followers_you_know || 0) - (a.tweeter_home_followers_you_know || 0);
	            })
	        });
	        filtered_matches.sort(function(a, b) {
	            return (b.match_twitter[0].followers_you_know || 0) - (a.match_twitter[0].followers_you_know || 0);
	        });
	        console.log('filtered matches:', filtered_matches.length)
	        this.set('sortedFilteredMatches', filtered_matches)
	    }

	    uniques(leagues, matches) {
	        if (leagues && matches && leagues.length > 0 && matches.length > 0) {
	            console.log('leauges:', leagues.length, 'matches:', matches.length, this.uniqueLeagues);
	            if (this.uniqueLeagues.length == 0) {
	                var ul = []
	                matches.forEach(function(m) {
	                    var uln = ul.map(function(m) {
	                        return m.league
	                    });
	                    if (uln.indexOf(m.league) == -1) {
	                        leagues.forEach(function(l) {
	                            if (m.league == l.league) {
	                                ul.push(l)
	                            }
	                        })
	                    }
	                });
	                console.log('uniques leagues:', ul.length)
	                this.set('uniqueLeagues', ul);
	                Polymer.RenderStatus.afterNextRender(this, function() {
	                    this.sortFilter()
	                })
	            }
	        }
	    }
	    domain(url) {
	        return 'http://' + nativeDomain() + url
	    }

	}
	customElements.define(MyView4.is, MyView4);      
   </script>
</dom-module>